<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é›¨å°èŠ±æ¶ˆè´¹è®°å½•</title>
    <link rel="stylesheet" href="xyyh-query.css">
    <link rel="stylesheet" href="xyyh-consume.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>å¾</text></svg>">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1>ğŸ·ï¸ å°é›¨å°èŠ±æ¶ˆè´¹è®°å½•</h1>
            </div>
        </header>
        
        <main class="main-content" style="padding: 30px;">
            <div class="time-period-selector">
                <label for="periodSelect">é€‰æ‹©æ‹å–è½®æ¬¡ï¼š</label>
                <select id="periodSelect" onchange="changePeriod()">
                    <!-- æ—¶æ®µé€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </select>
            </div>
            
            <h2 id="currentPeriodTitle" style="text-align: center; margin-bottom: 10px; color: var(--dark-text); font-weight: 600;">æœ¬è½®ç«æ‹æ˜ç»† <span id="latestPeriodNotice" class="latest-period-notice" style="display: none;">âœ¨ æœ€æ–°</span></h2>
            
            <!-- åœ¨æœ¬è½®ç«æ‹æ˜ç»†ä¸‹é¢æ˜¾ç¤ºç»Ÿè®¡èŒƒå›´ -->
            <div class="title-stats-info" id="statsRange">
                <!-- ç»Ÿè®¡èŒƒå›´å°†åŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- è®°å½•æ€»æ•°å’Œå‚ä¸äººæ•°æ˜¾ç¤º -->
            <div class="summary-info" id="summaryInfo">
                <!-- æ€»è®°å½•æ•°å’Œå‚ä¸äººæ•°å°†åŠ¨æ€åŠ è½½ -->
            </div>
            
            <div class="consume-table-container">
                <table class="consume-table">
                    <thead>
                        <tr>
                            <th class="index-cell" style="min-width: 70px;">åºå·</th>
                            <th class="bidder-cell" style="min-width: 120px;">ç«æ‹æˆåŠŸè€…</th>
                            <th class="item-cell" style="min-width: 160px;">æ‹å“å†…å®¹</th>
                            <th class="price-cell" style="min-width: 80px;" id="priceHeader">æœ€ç»ˆæˆäº¤ä»·</th>
                        </tr>
                    </thead>
                    <tbody id="consumeTableBody">
                        <!-- æ¶ˆè´¹è®°å½•å°†åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
            
            <!-- ç»Ÿè®¡èŒƒå›´ä¿¡æ¯ï¼ˆç°åœ¨åªæ˜¾ç¤ºæ‹å–æ—¶é—´ï¼Œé å³æ˜¾ç¤ºï¼‰ -->
            <div class="stat-info" id="statInfo">
                <!-- æ‹å–æ—¶é—´å°†åŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="paginationContainer" class="pagination" style="display: none;">
                <button id="prevPage" title="ä¸Šä¸€é¡µ">â†</button>
                <div class="page-numbers" id="pageNumbers"></div>
                <button id="nextPage" title="ä¸‹ä¸€é¡µ">â†’</button>
                <div class="page-info" id="pageInfo"></div>
            </div>
            <div class="disclaimer">
                æœ¬è¡¨æ ¼ä»…ç»Ÿè®¡æ‹å–ä¼šæ—¶çš„æ‹å“æƒ…å†µï¼Œå¦‚éœ€äº¤æ¢æ‹å“è¯·è”ç³»æˆ¿ç®¡ï¼Œæ­¤è¡¨æ ¼ä¸è¿›è¡Œäº¤æ¢
            </div>            
            <div style="text-align: center; margin-top: 20px;">
                <a href="index.html" class="back-btn">
                    <span>â†</span> è¿”å›æŸ¥è¯¢é¡µé¢
                </a>
            </div>
        </main>
    </div>

    <!-- å¼•å…¥æ¶ˆè´¹è®°å½•æ•°æ®æ–‡ä»¶ -->
    <script src="xyyh-consume-data.js"></script>
    <script src="xyyh-shared.js"></script>
    <script>
        // å½“å‰é€‰ä¸­çš„æ—¶é—´æ®µ
        let currentPeriod = ConsumeDataManager.getDefaultPeriod();
        // è·å–æœ€æ–°æ—¶é—´æ®µ
        let latestPeriod = ConsumeDataManager.getLatestPeriod();
        // åˆ†é¡µç›¸å…³å˜é‡
        const itemsPerPage = 10;
        let currentPage = 1;
        let totalPages = Math.ceil(ConsumeDataManager.getDataByPeriod(currentPeriod).length / itemsPerPage);

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            populatePeriodSelector();
            displayConsumeTable(currentPage);
            renderPagination();
            updateStatsRangeDisplay(); // æ›´æ–°æ ‡é¢˜ä¸‹é¢çš„ç»Ÿè®¡èŒƒå›´æ˜¾ç¤º
            updateStatInfo(); // æ›´æ–°è¡¨æ ¼ä¸‹æ–¹çš„æ‹å–æ—¶é—´æ˜¾ç¤º
            updateSummaryInfo(); // æ›´æ–°è®°å½•æ€»æ•°å’Œå‚ä¸äººæ•°
            updateLatestPeriodNotice(); // æ›´æ–°æœ€æ–°è½®æ¬¡æç¤º
            
            // ç»‘å®šåˆ†é¡µæŒ‰é’®äº‹ä»¶
            document.getElementById('prevPage').addEventListener('click', prevPage);
            document.getElementById('nextPage').addEventListener('click', nextPage);
        });

        // å¡«å……æ—¶é—´æ®µé€‰æ‹©å™¨
        function populatePeriodSelector() {
            const periodSelect = document.getElementById('periodSelect');
            const periods = ConsumeDataManager.getPeriods();
            
            periods.forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                option.textContent = period;
                if (period === currentPeriod) {
                    option.selected = true;
                }
                periodSelect.appendChild(option);
            });
        }

        // åˆ‡æ¢æ—¶é—´æ®µ
        function changePeriod() {
            currentPeriod = document.getElementById('periodSelect').value;
            currentPage = 1;
            totalPages = Math.ceil(ConsumeDataManager.getDataByPeriod(currentPeriod).length / itemsPerPage);
            document.getElementById('currentPeriodTitle').innerHTML = `${currentPeriod.includes('æœ¬è½®') ? 'æœ¬è½®ç«æ‹æ˜ç»†' : currentPeriod + ' ç«æ‹æ˜ç»†'} <span id="latestPeriodNotice" class="latest-period-notice" style="display: ${currentPeriod === latestPeriod ? 'inline-block' : 'none'};">âœ¨ æœ€æ–°</span>`;
            displayConsumeTable(currentPage);
            renderPagination();
            updateStatsRangeDisplay(); // æ›´æ–°æ ‡é¢˜ä¸‹é¢çš„ç»Ÿè®¡èŒƒå›´æ˜¾ç¤º
            updateStatInfo(); // æ›´æ–°è¡¨æ ¼ä¸‹æ–¹çš„æ‹å–æ—¶é—´æ˜¾ç¤º
            updateSummaryInfo(); // æ›´æ–°è®°å½•æ€»æ•°å’Œå‚ä¸äººæ•°
            updateLatestPeriodNotice(); // æ›´æ–°æœ€æ–°è½®æ¬¡æç¤º
        }

        // æ˜¾ç¤ºç»Ÿè®¡èŒƒå›´ï¼ˆç°åœ¨æ”¾åœ¨æ ‡é¢˜ä¸‹é¢ï¼‰
        function updateStatsRangeDisplay() {
            const statsRangeElement = document.getElementById('statsRange');
            if (currentPeriod) {
                const statsRange = ConsumeDataManager.getStatsRangeByPeriod(currentPeriod);
                statsRangeElement.textContent = `æœ¬è½®å°èŠ±ç»Ÿè®¡èŒƒå›´ :  ${statsRange}`;
            } else {
                statsRangeElement.textContent = '';
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆç°åœ¨åªæ˜¾ç¤ºæ‹å–æ—¶é—´ï¼Œé å³æ˜¾ç¤ºï¼‰
        function updateStatInfo() {
            const statInfoElement = document.getElementById('statInfo');
            if (currentPeriod) {
                const auctionTime = ConsumeDataManager.getAuctionTimeByPeriod(currentPeriod);
                statInfoElement.innerHTML = `æœ¬è½®æ‹å–æ—¶é—´ :  ${auctionTime}`; // åªæ˜¾ç¤ºæ‹å–æ—¶é—´
            } else {
                statInfoElement.textContent = '';
            }
        }

        // æ›´æ–°è®°å½•æ€»æ•°å’Œå‚ä¸äººæ•°
        function updateSummaryInfo() {
            const records = ConsumeDataManager.getDataByPeriod(currentPeriod);
            const totalRecords = records.length;
            const participatingUsers = [...new Set(records.map(record => record.bidder))].length;

            document.getElementById('summaryInfo').innerHTML = `å…±æ‰¾åˆ° ${totalRecords} æ¡è®°å½•ï¼Œ${participatingUsers} äººå‚ä¸`;
        }

        // æ›´æ–°æœ€æ–°è½®æ¬¡æç¤º
        function updateLatestPeriodNotice() {
            const noticeElement = document.getElementById('latestPeriodNotice');
            if (currentPeriod === latestPeriod) {
                noticeElement.style.display = 'inline-block';
            } else {
                noticeElement.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ¶ˆè´¹è®°å½•è¡¨æ ¼ï¼ˆå¸¦åˆ†é¡µï¼‰
        function displayConsumeTable(page = 1) {
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = ConsumeDataManager.getDataByPeriod(currentPeriod).slice(startIndex, endIndex);
            
            const consumeTableBody = document.getElementById('consumeTableBody');
            
            // æ ¹æ®æ˜¯å¦ä¸ºæœ€æ–°æ—¶é—´æ®µè°ƒæ•´è¡¨å¤´å’Œåˆ—æ•°
            adjustTableHeaders();
            
            if (pageData.length === 0) {
                const colSpan = isLatestPeriod(currentPeriod) ? 4 : 3;
                consumeTableBody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" style="text-align: center; color: #888; padding: 40px;">æš‚æ— æ¶ˆè´¹è®°å½•</td>
                    </tr>
                `;
                return;
            }

            let html = '';
            pageData.forEach((record, index) => {
                const globalIndex = startIndex + index + 1; // å…¨å±€åºå·
                if (isLatestPeriod(currentPeriod)) {
                    // æœ€æ–°æ—¶é—´æ®µæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä»·æ ¼ï¼‰
                    html += `
                        <tr>
                            <td class="index-cell">${globalIndex}</td>
                            <td class="bidder-cell">${Utils.escapeHtml(record.bidder)}</td>
                            <td class="item-cell">${Utils.escapeHtml(record.item)}</td>
                            <td class="price-cell">${record.price}</td>
                        </tr>
                    `;
                } else {
                    // éæœ€æ–°æ—¶é—´æ®µä¸æ˜¾ç¤ºä»·æ ¼
                    html += `
                        <tr>
                            <td class="index-cell">${globalIndex}</td>
                            <td class="bidder-cell">${Utils.escapeHtml(record.bidder)}</td>
                            <td class="item-cell">${Utils.escapeHtml(record.item)}</td>
                        </tr>
                    `;
                }
            });
            consumeTableBody.innerHTML = html;
        }

        // è°ƒæ•´è¡¨å¤´æ˜¾ç¤º
        function adjustTableHeaders() {
            const priceHeader = document.getElementById('priceHeader');
            
            if (isLatestPeriod(currentPeriod)) {
                // æ˜¾ç¤ºä»·æ ¼åˆ—
                priceHeader.style.display = '';
                // æ›´æ–°è¡¨å¤´æ–‡æœ¬
                priceHeader.textContent = 'æœ€ç»ˆæˆäº¤å°èŠ±/ä¸ª';
            } else {
                // éšè—ä»·æ ¼åˆ—
                priceHeader.style.display = 'none';
            }
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºæœ€æ–°æ—¶é—´æ®µ
        function isLatestPeriod(period) {
            return period === latestPeriod;
        }

        // ç”Ÿæˆåˆ†é¡µæ§ä»¶
        function renderPagination() {
            const paginationContainer = document.getElementById('paginationContainer');
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');
            const pageNumbersContainer = document.getElementById('pageNumbers');
            const pageInfo = document.getElementById('pageInfo');
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            pageNumbersContainer.innerHTML = '';
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            // ç”Ÿæˆé¡µç æŒ‰é’®
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.classList.add('page-number');
                pageButton.textContent = i;
                pageButton.onclick = () => goToPage(i);
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageNumbersContainer.appendChild(pageButton);
            }
            
            // æ›´æ–°é¡µç ä¿¡æ¯
            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
            
            // æ§åˆ¶ä¸Šä¸€é¡µä¸‹ä¸€é¡µæŒ‰é’®çš„å¯ç”¨çŠ¶æ€
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            
            currentPage = page;
            displayConsumeTable(currentPage);
            renderPagination();
        }

        // ä¸Šä¸€é¡µ
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayConsumeTable(currentPage);
                renderPagination();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                displayConsumeTable(currentPage);
                renderPagination();
            }
        }
    </script>
</body>
</html>